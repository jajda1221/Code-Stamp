<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>EMS Code Time Stamp</title>

  <!-- App icon (make sure your uploaded PNG is named icon.png in the repo root) -->
  <link rel="icon" type="image/png" href="icon.png">
  <link rel="apple-touch-icon" href="icon.png">

  <style>
    :root{
      --gap: 12px;
      --radius: 14px;
      --border: 1px solid rgba(0,0,0,.12);
      --bg: #f6f7fb;
      --card: #fff;
      --text: #111;
      --muted: #555;
    }
    *{ box-sizing: border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    header{
      padding: 16px;
      background: var(--card);
      border-bottom: var(--border);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    h1{ margin:0 0 10px; font-size: 20px; }
    .row{
      display:flex;
      gap: var(--gap);
      flex-wrap: wrap;
      align-items: end;
    }
    label{
      display:grid;
      gap:6px;
      font-size:13px;
      color:#333;
      min-width: 220px;
    }
    input, select, button{
      font: inherit;
      border-radius: 12px;
      border: var(--border);
      padding: 10px 12px;
      background: #fff;
    }
    input{ width: 100%; }
    select{ width: 100%; }

    button{
      cursor:pointer;
      font-weight: 800;
    }
    button:active{ transform: translateY(1px); }
    .btn{
      padding: 10px 14px;
      border-radius: 12px;
      border: var(--border);
      background: #fff;
      font-weight: 900;
      white-space: nowrap;
    }
    .btn.primary{ background:#eef2ff; }
    .btn.danger{ background:#fff0f0; }
    .pill{
      display:inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      border: var(--border);
      background: #f1f3f9;
      font-weight: 900;
      letter-spacing: .5px;
    }
    .hint{
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }
    .hint strong{ color:#222; }
    .statusline{
      margin-top: 10px;
      font-size: 12px;
      color:#333;
      min-height: 16px;
    }

    main{
      padding: 16px;
      max-width: 1100px;
      margin: 0 auto;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: var(--gap);
      margin-top: 14px;
    }

    .bigbtn{
      padding: 18px 16px;
      font-size: 18px;
      font-weight: 900;
      border-radius: 18px;
      border: var(--border);
      background: #fff;
      text-align:left;
      min-height: 72px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .count{
      font-size: 13px;
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 999px;
      border: var(--border);
      background: #f6f7fb;
    }

    .panels{
      display:grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: var(--gap);
      margin-top: 16px;
    }
    @media (max-width: 900px){
      .panels{ grid-template-columns: 1fr; }
      label{ min-width: 100%; }
    }

    .card{
      background: var(--card);
      border: var(--border);
      border-radius: var(--radius);
      padding: 14px;
    }
    .card h2{ margin:0 0 10px; font-size: 16px; }

    textarea{
      width:100%;
      min-height: 320px;
      resize: vertical;
      border-radius: 12px;
      border: var(--border);
      padding: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 13px;
      background: #fff;
    }

    .actions{
      display:flex;
      gap: var(--gap);
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .smallmuted{ font-size: 12px; color: var(--muted); margin-top: 10px; }
  </style>
</head>

<body>
  <header>
    <h1>EMS Code Time Stamp</h1>

    <div class="row">
      <label>
        ZIP Code (US)
        <div style="display:flex; gap:10px; align-items:center;">
          <input id="zip" inputmode="numeric" autocomplete="postal-code" placeholder="e.g. 37211" maxlength="10" />
          <button class="btn primary" id="applyZip" type="button">Apply ZIP</button>
        </div>
      </label>

      <label>
        Timezone (override if needed)
        <select id="tz">
          <option value="">Use device timezone</option>
          <option value="America/New_York">America/New_York (Eastern)</option>
          <option value="America/Chicago">America/Chicago (Central)</option>
          <option value="America/Denver">America/Denver (Mountain)</option>
          <option value="America/Los_Angeles">America/Los_Angeles (Pacific)</option>
          <option value="America/Anchorage">America/Anchorage (Alaska)</option>
          <option value="Pacific/Honolulu">Pacific/Honolulu (Hawaii)</option>
        </select>
      </label>

      <div style="flex:1"></div>

      <div class="pill" id="clock">--:--:--</div>
    </div>

    <div class="hint" id="zipHint">
      Enter a ZIP and tap <strong>Apply ZIP</strong> to auto-pick a best-guess timezone. You can always override it.
    </div>

    <div class="statusline" id="topStatus"></div>
  </header>

  <main>
    <div class="grid" id="buttons"></div>

    <div class="panels">
      <div class="card">
        <h2>Event Log</h2>
        <textarea id="log" readonly></textarea>

        <div class="actions">
          <button class="btn" id="copy" type="button">Copy Log</button>
          <button class="btn" id="download" type="button">Download .txt</button>
          <button class="btn" id="undo" type="button">Undo Last</button>
          <button class="btn danger" id="clear" type="button">Clear All</button>
        </div>

        <div class="smallmuted" id="status">No events yet.</div>
      </div>

      <div class="card">
        <h2>Notes</h2>
        <textarea id="notes" placeholder="Notes (optional)…"></textarea>
        <div class="smallmuted">
          Tip: If your area is in a different timezone than the “best guess,” use the timezone dropdown.
        </div>
      </div>
    </div>
  </main>

<script>
(() => {
  // =========================
  // BUTTON LIST
  // =========================
  const ITEMS = [
    "Rhythm check",
    "CPR Started",
    "Defibrillation",
    "IV/IO Access",
    "Epinephrine",
    "Airway Established",
    "Narcan",
    "Amiodarone",
    "Lidocaine",
    "Blood Glucose",
    "Warming",
    "Sodium Bicarbonate",
    "Fluids/Pressure Bag"
  ];

  // =========================
  // ZIP -> Timezone best-guess
  // NOTE: Some states have multiple timezones; dropdown override remains available.
  // =========================
  const STATE_TO_TZ = {
    AL:"America/Chicago", AK:"America/Anchorage", AZ:"America/Denver", AR:"America/Chicago",
    CA:"America/Los_Angeles", CO:"America/Denver", CT:"America/New_York", DE:"America/New_York",
    DC:"America/New_York", FL:"America/New_York", GA:"America/New_York", HI:"Pacific/Honolulu",
    ID:"America/Denver", IL:"America/Chicago", IN:"America/New_York", IA:"America/Chicago",
    KS:"America/Chicago", KY:"America/New_York", LA:"America/Chicago", ME:"America/New_York",
    MD:"America/New_York", MA:"America/New_York", MI:"America/New_York", MN:"America/Chicago",
    MS:"America/Chicago", MO:"America/Chicago", MT:"America/Denver", NE:"America/Chicago",
    NV:"America/Los_Angeles", NH:"America/New_York", NJ:"America/New_York", NM:"America/Denver",
    NY:"America/New_York", NC:"America/New_York", ND:"America/Chicago", OH:"America/New_York",
    OK:"America/Chicago", OR:"America/Los_Angeles", PA:"America/New_York", RI:"America/New_York",
    SC:"America/New_York", SD:"America/Chicago", TN:"America/Chicago", TX:"America/Chicago",
    UT:"America/Denver", VT:"America/New_York", VA:"America/New_York", WA:"America/Los_Angeles",
    WV:"America/New_York", WI:"America/Chicago", WY:"America/Denver"
  };

  // =========================
  // Storage
  // =========================
  const LS_KEY = "ems_codelog_v3";
  const loadState = () => {
    try { return JSON.parse(localStorage.getItem(LS_KEY)) || null; } catch { return null; }
  };

  const state = loadState() || { zip:"", tz:"", notes:"", events:[] };
  const saveState = () => localStorage.setItem(LS_KEY, JSON.stringify(state));

  // =========================
  // Elements
  // =========================
  const zipEl = document.getElementById("zip");
  const applyZipBtn = document.getElementById("applyZip");
  const tzEl = document.getElementById("tz");
  const buttonsEl = document.getElementById("buttons");
  const logEl = document.getElementById("log");
  const notesEl = document.getElementById("notes");
  const statusEl = document.getElementById("status");
  const topStatusEl = document.getElementById("topStatus");
  const zipHintEl = document.getElementById("zipHint");
  const clockEl = document.getElementById("clock");

  // =========================
  // Helpers
  // =========================
  function sanitizeZip(z){
    return (z || "").trim().replace(/[^\d]/g, "").slice(0, 5);
  }
  function setTopStatus(msg){
    topStatusEl.textContent = msg || "";
  }
  function nowParts(timeZone){
    const d = new Date();
    const dtf = new Intl.DateTimeFormat(undefined, timeZone
      ? { timeZone, year:"numeric", month:"2-digit", day:"2-digit", hour12:false, hour:"2-digit", minute:"2-digit", second:"2-digit" }
      : { year:"numeric", month:"2-digit", day:"2-digit", hour12:false, hour:"2-digit", minute:"2-digit", second:"2-digit" }
    );
    return dtf.formatToParts(d);
  }
  function formatStamp(timeZone){
    const parts = nowParts(timeZone);
    const get = (t) => parts.find(p => p.type === t)?.value || "";
    return `${get("year")}-${get("month")}-${get("day")} ${get("hour")}:${get("minute")}:${get("second")}`;
  }
  function formatClock(timeZone){
    const d = new Date();
    const dtf = new Intl.DateTimeFormat(undefined, timeZone
      ? { timeZone, hour12:false, hour:"2-digit", minute:"2-digit", second:"2-digit" }
      : { hour12:false, hour:"2-digit", minute:"2-digit", second:"2-digit" }
    );
    return dtf.format(d);
  }
  function countsByItem(){
    const map = {};
    for (const it of ITEMS) map[it] = 0;
    for (const e of state.events) map[e.item] = (map[e.item] || 0) + 1;
    return map;
  }

  // =========================
  // Render
  // =========================
  function renderButtons(){
    buttonsEl.innerHTML = "";
    const counts = countsByItem();

    for (const item of ITEMS){
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "bigbtn";
      btn.innerHTML = `<span>${item}</span><span class="count">${counts[item] || 0}</span>`;
      btn.addEventListener("click", () => addEvent(item));
      buttonsEl.appendChild(btn);
    }
  }

  function renderLog(){
    const tzLabel = state.tz ? state.tz : "Device timezone";
    const header = [
      `Timezone: ${tzLabel}`,
      state.zip ? `ZIP: ${state.zip}` : `ZIP: (none)`,
      `Events: ${state.events.length}`,
      ""
    ].join("\n");

    const notesBlock = state.notes?.trim()
      ? `Notes:\n${state.notes.trim()}\n\n`
      : "";

    const lines = state.events.map((e, i) =>
      `${String(i+1).padStart(3,"0")}  ${e.stamp}  -  ${e.item}`
    );

    logEl.value = header + notesBlock + lines.join("\n");

    statusEl.textContent = state.events.length
      ? `Last: ${state.events[state.events.length - 1].item} @ ${state.events[state.events.length - 1].stamp}`
      : "No events yet.";

    renderButtons();
  }

  function tickClock(){
    clockEl.textContent = formatClock(state.tz || "");
  }

  // =========================
  // Actions
  // =========================
  function addEvent(item){
    const stamp = formatStamp(state.tz || "");
    state.events.push({ item, stamp });
    saveState();
    renderLog();
  }

  function undoLast(){
    if (!state.events.length) return;
    state.events.pop();
    saveState();
    renderLog();
    setTopStatus("Undid last event.");
    setTimeout(() => setTopStatus(""), 1200);
  }

  // Clear All must clear BOTH events and notes (no confirm popups)
  function clearAll(){
    state.events = [];
    state.notes = "";
    notesEl.value = "";
    saveState();
    renderLog();
    setTopStatus("Cleared all events and notes.");
    setTimeout(() => setTopStatus(""), 1500);
  }

  async function copyLog(){
    try{
      await navigator.clipboard.writeText(logEl.value);
      setTopStatus("Copied log to clipboard.");
    } catch {
      // iOS fallback
      logEl.focus();
      logEl.select();
      setTopStatus("Clipboard blocked. Selected log text—tap Copy.");
    }
    setTimeout(() => setTopStatus(""), 1500);
  }

  function downloadLog(){
    const blob = new Blob([logEl.value], { type:"text/plain;charset=utf-8" });
    const a = document.createElement("a");
    const dt = new Date().toISOString().replace(/[:.]/g,"-");
    a.href = URL.createObjectURL(blob);
    a.download = `ems-codelog-${dt}.txt`;
    a.click();
    URL.revokeObjectURL(a.href);
    setTopStatus("Downloaded log file.");
    setTimeout(() => setTopStatus(""), 1500);
  }

  // =========================
  // ZIP lookup (Zippopotam.us)
  // =========================
  async function lookupZip(zip){
    const res = await fetch(`https://api.zippopotam.us/us/${zip}`, { cache: "no-store" });
    if (!res.ok) throw new Error("ZIP not found");
    return res.json();
  }

  async function applyZip(){
    const clean = sanitizeZip(zipEl.value);
    zipEl.value = clean;

    if (!clean){
      state.zip = "";
      saveState();
      renderLog();
      zipHintEl.innerHTML = `Enter a ZIP and tap <strong>Apply ZIP</strong> to auto-pick a best-guess timezone. You can always override it.`;
      setTopStatus("Cleared ZIP.");
      setTimeout(() => setTopStatus(""), 1200);
      return;
    }

    if (clean.length !== 5){
      setTopStatus("ZIP must be 5 digits.");
      return;
    }

    setTopStatus("Looking up ZIP…");

    try{
      const data = await lookupZip(clean);
      const place = data.places && data.places[0];
      const city = place ? place["place name"] : "";
      const stateAbbr = place ? place["state abbreviation"] : "";

      const guessTz = STATE_TO_TZ[stateAbbr] || "";

      state.zip = clean;

      // Auto-set timezone to best-guess (user can override anytime)
      if (guessTz){
        state.tz = guessTz;
        tzEl.value = guessTz;
      }

      saveState();
      renderLog();

      zipHintEl.innerHTML =
        `ZIP <strong>${clean}</strong> → ${city ? city + ", " : ""}${stateAbbr || ""}. ` +
        (guessTz ? `Best-guess timezone set to <strong>${guessTz}</strong>.` : `Could not guess timezone; choose from dropdown.`) +
        ` You can override anytime.`;

      setTopStatus("ZIP applied.");
      setTimeout(() => setTopStatus(""), 1500);
    } catch {
      setTopStatus("Could not look up that ZIP. Check the number and try again.");
    }
  }

  // auto-apply when 5 digits typed
  let zipTimer = null;
  function onZipInput(){
    const clean = sanitizeZip(zipEl.value);
    zipEl.value = clean;

    if (zipTimer) clearTimeout(zipTimer);
    if (clean.length === 5){
      zipTimer = setTimeout(() => applyZip(), 350);
    }
  }

  // =========================
  // Init
  // =========================
  function init(){
    zipEl.value = state.zip || "";
    tzEl.value = state.tz || "";
    notesEl.value = state.notes || "";

    renderButtons();
    renderLog();
    tickClock();
    setInterval(tickClock, 250);

    applyZipBtn.addEventListener("click", applyZip);
    zipEl.addEventListener("input", onZipInput);

    // iOS reliability
    zipEl.addEventListener("blur", () => {
      const clean = sanitizeZip(zipEl.value);
      if (clean.length === 5) applyZip();
    });

    tzEl.addEventListener("change", () => {
      state.tz = tzEl.value; // "" = device timezone
      saveState();
      renderLog();
      setTopStatus("Timezone updated.");
      setTimeout(() => setTopStatus(""), 1200);
    });

    notesEl.addEventListener("input", () => {
      state.notes = notesEl.value;
      saveState();
      renderLog();
    });

    document.getElementById("undo").addEventListener("click", undoLast);
    document.getElementById("clear").addEventListener("click", clearAll);
    document.getElementById("copy").addEventListener("click", copyLog);
    document.getElementById("download").addEventListener("click", downloadLog);
  }

  window.addEventListener("error", (e) => {
    setTopStatus("App error: " + (e?.message || "Unknown error"));
  });

  init();
})();
</script>
</body>
</html>